---
title: 连接池规范
---

# JDBC 连接池配置指南

grus 框架使用 springboot 官方推荐的连接池 HikariCP，下文全部针对的是 HikariCP。

**默认的，grus 框架已经实现了本规范。**

由于关爱通线上业务是使用的同一个`MYSQL`物理实例，如果大家不当配置连接池，那么数据库连接存在很容易达到上限。

举个例子，假如某个应用的初始化连接数量设置为 10，而我们一般部署三台，那么该应用上线后正常就有 30 个数据库连接。

假如数据库连接上限为 1000，那么我们仅仅最多支撑 33 个应用了。实际关爱通应用有上百个，平摊下来，每个应用的并发没有那么高。

综上，为了防止滥用或者不正当使用连接池，针对连接池配置有如下规范：

## 基础参数

> 注意当前的推荐值为针对目前共用 mysql 机器的情况，后续 db 迁移后另行通知。

| 参数名                 | 含义                                                                                                      | 推荐值     |
| ---------------------- | --------------------------------------------------------------------------------------------------------- | ---------- |
| dataSourceClassName    | mysql 佩 HikariCP 的推荐 com.mysql.jdbc.jdbc2.optional.MysqlDataSource                                    |            |
| **maximumPoolSize**    | 连接池允许的**最大连接总数**（包含空闲和使用中），因此此参数需要看实际业务是否存在高 TPS 的场景，酌情处理 | 5-10       |
| **minimumIdle**        | 连接池中保留的最小空闲连接数                                                                              | 1-3        |
| connectionTimeout      | 连接超时时间 _原框架 Default: 30000 (30 seconds)_，此原始值过大，不适合微服务架构。最小值为 250ms         | 3s         |
| **idleTimeout**        | 连接设置为空闲 _Default: 600000 (10 minutes)_ 最小值为 10s                                                | 30s-5m     |
| **maxLifetime**        | 连接的最大存活时间 Default: 1800000 (30 minutes)                                                          | 5m-10m     |
| poolName               | 给连接池起个名，便于从日志角度看待连接问题，依据业务应用进行命名                                          | APPID      |
| _validationTimeout_    | _多长时间检测下连接 取值简易小于 connectionTimeout 默认值 5 秒_                                           | _5s_       |
| leakDetectionThreshold | _多长时间检测下连接池是否泄漏 默认为 0 不检测.此参数可以有效检测连接数泄漏的问题_                         | _30s 以上_ |

## 其他优化参数

| 参数名                    | 含义                          | 推荐值        |
| ------------------------- | ----------------------------- | ------------- |
| useServerPrepStmts        | 打开 mysql 服务器端预编译     | true          |
| **prepStmtCacheSize**     | **driver 端缓存大小 默认 25** | **250-500**   |
| **prepStmtCacheSqlLimit** | **最大缓存限制 默认 256**     | **1024-2048** |
| **cachePrepStmts**        | **打开本地 Driver 开关**      | **true**      |
